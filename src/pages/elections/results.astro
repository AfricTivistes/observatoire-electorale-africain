---
import Layout from '../../layouts/MainLayout.astro';
import PageHeader from '../../components/PageHeader.tsx';
import ResultData from '../../components/elections/ResultData.tsx';
import { FaChartBar, FaSearch } from 'react-icons/fa';

// Importer les collections
import { getCollection } from 'astro:content';

// Récupérer les données des élections et résultats
const elections = await getCollection('elections');
const resultatsElections = await getCollection('resultatsElections');

// Filtrer les élections Précédentes et les trier par date
// Pagination
const itemsPerPage = 2;
const currentPage = Astro.url.searchParams.get('page') ? parseInt(Astro.url.searchParams.get('page')) : 1;

// Trier d'abord toutes les élections terminées
const completedElections = elections
  .filter(election => election.data.statut === "Précédente")
  .sort((a, b) => new Date(b.data.dateElection).getTime() - new Date(a.data.dateElection).getTime());

const totalPages = Math.ceil(completedElections.length / itemsPerPage);

// Récupérer d'abord tous les résultats qui correspondent aux élections terminées
// Récupérer tous les résultats pour les élections complétées
const electionsWithResults = completedElections.map(election => {
  const resultat = resultatsElections.find(r => r.data.Elections_id === election.data.id);
  return {
    election,
    resultat
  };
}).filter(({ resultat }) => resultat !== undefined);

// Paginer après avoir filtré les résultats valides
const paginatedElectionsWithResults = electionsWithResults
  .slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

// Formater les nombres
function formatNumber(num: number) {
  return new Intl.NumberFormat('fr-FR').format(num);
}
---

<Layout title="Résultats des Élections | Observatoire des Élections en Afrique">
  <PageHeader
    title="Résultats des Élections"
    subtitle="Consultez les résultats des élections récentes à travers le continent africain"
    breadcrumbs={[
      { label: 'Accueil', href: '/' },
      { label: 'Élections', href: '/elections' },
      { label: 'Résultats' }
    ]}
  >
    <FaChartBar className="text-farafina-primary text-3xl" slot="icon" />
  </PageHeader>

  <div class="container mx-auto px-4 py-8">
    <!-- Barre de recherche -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <div class="max-w-3xl mx-auto">
        <div class="relative">
          <input
            type="text"
            placeholder="Rechercher par pays, type d'élection ou année..."
            class="w-full py-3 pl-12 pr-4 rounded-lg border border-gray-200 focus:ring-2 focus:ring-farafina-primary focus:border-transparent"
          />
          <FaSearch className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400" />
          <button class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-farafina-primary text-white px-4 py-1 rounded-md hover:bg-farafina-primary/90 transition-colors">
            Rechercher
          </button>
        </div>
      </div>
    </div>

    <!-- Résultats des élections -->
    <div class="space-y-8">
      {paginatedElectionsWithResults.map(({ election, resultat }) => (
        <ResultData 
          election={election} 
          resultat={resultat} 
          formatNumber={formatNumber}
          client:load
        />
      ))}
    </div>

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="flex justify-center items-center mt-8 space-x-2">
        {currentPage > 1 && (
          <a
            href={`/elections/results?page=${currentPage - 1}`}
            class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200"
          >
            Précédent
          </a>
        )}

        {Array.from({ length: totalPages }, (_, i) => (
          <a
            href={`/elections/results?page=${i + 1}`}
            class={`px-4 py-2 rounded-lg ${
              currentPage === i + 1
                ? 'bg-farafina-primary text-white'
                : 'bg-gray-100 hover:bg-gray-200'
            }`}
          >
            {i + 1}
          </a>
        ))}

        {currentPage < totalPages && (
          <a
            href={`/elections/results?page=${currentPage + 1}`}
            class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200"
          >
            Suivant
          </a>
        )}
      </div>
    )}
  </div>
</Layout>