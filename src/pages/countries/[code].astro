---
import { getCollection } from "astro:content";
import Layout from "../../layouts/MainLayout.astro";
import PageHeader from "../../components/PageHeader.tsx";
import CountryCard from "../../components/countries/CountryCard.tsx";
import DemographicChart from "../../components/countries/DemographicChart.tsx";
import LegalFramework from "../../components/countries/LegalFramework.tsx";
import ElectionTimeline from "../../components/countries/ElectionTimeline.tsx";
import AfricaMap from "../../components/countries/AfricaMap.tsx";
import ToCountryLink from "@/components/common/ToCountryLink.astro";
import {
  FaGlobeAfrica,
  FaVoteYea,
  FaNewspaper,
  FaBalanceScale,
  FaUsers,
  FaChartBar,
  FaCalendarAlt,
  FaExclamationTriangle,
  FaTwitter,
  FaLinkedin,
  FaFacebookF,
  FaEnvelope,
} from "react-icons/fa";
import { Image } from "astro:assets";

export async function getStaticPaths() {
  const pays = await getCollection("pays");

  return pays.map((entry) => ({
    params: { code: entry.data.code?.toLowerCase() },
    props: {
      country: entry.data,
    },
  }));
}

const { country } = Astro.props;

const ressources = await getCollection("ressources");
const elections = await getCollection("elections");
const resultatsElections = await getCollection("resultatsElections");
const defis = await getCollection("defisElections");
const organismesElectoraux = await getCollection("organismesElectoraux");
const organisations = await getCollection("organisations");

const legalFramework3 = ressources?.filter(
  (ressource) => ressource.data.Pays_id === country.id,
);
const organismes = organismesElectoraux?.filter(
  (organisme) => organisme.data.Pays_id === country.id,
);

const electionEvents3 = elections
  ?.filter((election) => election.data.Pays_id === country.id)
  .sort((a, b) => {
    const dateA = new Date(a.data.dateElection).getTime();
    const dateB = new Date(b.data.dateElection).getTime();
    return dateB - dateA;
  });

const organisation = organisations
  .filter((organisation) => organisation.data.pays === country.name)
  .map((organisation) => ({
    nom: organisation.data.nom,
    statut: organisation.data.statut,
    typeOrganisation: organisation.data.typeOrganisation,
    nombreDePaysCouverts: organisation.data.nombreDePaysCouverts,
    ville: organisation.data.ville,
    anneeDeCreation: organisation.data.anneeDeCreation,
    zonesCouverts: organisation.data.zonesCouverts,
    domainesExpertise: organisation.data.domainesExpertise,
    mobilisationsObservateurs: organisation.data.mobilisationsObservateurs,
    siteweb: organisation.data.siteweb,
    telephone: organisation.data.telephone,
    email: organisation.data.email,
    pays: organisation.data.pays,
  }));

const electoralOrganism = {
  politicalSystem: country.politicalSystem,
  electoralModel: country.modele,
  vote: {
    presidentialVote: country.vote.presidentialVote,
    presidentialscrutinMode: country.vote.presidentialscrutinMode,
    presidentialResults: country.vote.presidentialResults,
    legislativeVote: country.vote.legislativeVote,
    legislativeResults: country.vote.legislativeResults,
    legislativeScrutinMode: country.vote.legislativeScrutinMode,
    validationBody: country.vote.validationBody,
    legislativeValidationBody: country.vote.legislativeValidationBody,
    disputesManagementBody: country.vote.disputesManagementBody,
    provisionalResultsBody: country.vote.provisionalResultsBody,
    type: "election-law" as const,
  },
  electoralOrganisms: organismes.map((organisme) => ({
    name: organisme.data.nom,
    ville: organisme.data.ville,
    anneeDeCreation: organisme.data.anneeDeCreation,
    siteweb: organisme.data.siteweb,
    telephone: organisme.data.telephone,
    email: organisme.data.email,
  })),
};

const legalFramework = {
  documents: legalFramework3
    //.filter((r) => r.data.type === "Constitution" || r.data.type === "Loi √âlectorale")
    .sort((a, b) => b.data.year - a.data.year)
    .map((r) => ({
      title: r.data.title,
      type: r.data.type,
      year: r.data.year,
      description: r.data.description || "",
      url: r.data.fichier || "",
    })),
  timeline: [
    {
      year: parseInt(
        country.electoralFramework?.constitution?.match(/\d{4}/)?.[0] ||
          new Date().getFullYear(),
      ),
      event: `Adoption de la Constitution actuelle`,
      type: "constitution",
    },
    {
      year: country.lastElection.year,
      event: `Derni√®re √©lection ${country.lastElection.type.toLowerCase()}`,
      type: "election-law",
    },
  ],
};

// Sample election timeline data
const electionEvents = electionEvents3.map((e) => {
  const resultatsElections3 = resultatsElections?.filter(
    (resultat) => resultat.data.Elections_id === e.data.id,
  );
  const defisElection = defis?.filter(
    (defi) => resultatsElections3[0]?.data.id === defi.data.resultats
  );
  return {
    results:
      e.data.statut === "Pr√©c√©dente"
        ? resultatsElections3[0]?.data.resultats
        : undefined,
    date: e.data.dateElection,
    type: e.data.typeElection,
    status: e.data.statut,
    turnout:
      e.data.statut === "Pr√©c√©dente"
        ? resultatsElections3[0]?.data.participation
        : undefined,
    vainqueur: resultatsElections3[0]?.data.resultats,
    description:
      e.data.statut === "Pr√©c√©dente"
        ? `√âlection ${e.data.typeElection.toLowerCase()} ${country.name}`
        : `Prochaine √©lection ${e.data.typeElection.toLowerCase()} pr√©vue`,
    defis: defisElection.length
      ? defisElection.map((defi) => ({
          libelle: defi.data.libelleDefis,
          type: defi.data.typeDefi,
          url: defi.data.sourceDefi,
          dateElection: e.data.dateElection,
        }))
      : [],
  };
});

const upcomingElections = [
  {
    type: electionEvents.find(
      (e) => e.status === "En pr√©paration" || e.status === "√Ä venir",
    )?.type,
    date: electionEvents.find(
      (e) => e.status === "En pr√©paration" || e.status === "√Ä venir",
    )?.date,
    daysRemaining: (() => {
      const upcomingDate = electionEvents.find(
        (e) => e.status === "En pr√©paration" || e.status === "√Ä venir",
      )?.date;
      return upcomingDate
        ? Math.ceil(
            (new Date(upcomingDate).getTime() - new Date().getTime()) /
              (1000 * 60 * 60 * 24),
          )
        : null;
    })(),
  },
];

const CountryInterface = {
  code: country.code,
  name: country.name,
  population: country.population,
  lastElection: {
    type: electionEvents.find((e) => e.status === "Pr√©c√©dente")?.type || "N/A",
    year: new Date(
      electionEvents.find((e) => e.status === "Pr√©c√©dente")?.date || 0,
    ).getFullYear(),
    turnout:
      electionEvents.find((e) => e.status === "Pr√©c√©dente")?.turnout || 0,
    nextElectionYear: upcomingElections[0]?.date
      ? new Date(upcomingElections[0].date).getFullYear()
      : 0,
  },
  politicalSystem: country.politicalSystem || "",
  demographics: country.demographics,
};
// Donn√©es pour les statistiques cl√©s
const keyStats = [
  {
    label: "Population",
    value: new Intl.NumberFormat("fr-FR").format(country.population),
    icon: FaUsers,
    color: "text-farafina-primary",
  },
  {
    label: "√âlecteurs Inscrits",
    value: new Intl.NumberFormat("fr-FR").format(
      country.demographics?.voterRegistration?.registered || 0,
    ),
    icon: FaChartBar,
    color: "text-farafina-accent",
  },
  {
    label: "Derni√®re √©lection",
    value: electionEvents.find((e) => e.status === "Pr√©c√©dente")?.date
      ? `${electionEvents.find((e) => e.status === "Pr√©c√©dente")?.type} (${new Date(
          electionEvents.find((e) => e.status === "Pr√©c√©dente")?.date || 0,
        ).getFullYear()})`
      : "N/A",
    icon: FaCalendarAlt,
    color: "text-farafina-secondary",
  },
  {
    label: "Participation",
    value: new Intl.NumberFormat("fr-FR").format(
      electionEvents.find((e) => e.status === "Pr√©c√©dente")?.turnout || 0,
    ),
    icon: FaVoteYea,
    color: "text-farafina-secondary",
  },

  {
    label: "Prochaine √©lection",
    value: upcomingElections[0]?.date
      ? new Date(upcomingElections[0].date).getFullYear()
      : "N/A",
    icon: FaCalendarAlt,
    color: "text-farafina-blue",
  },
];

const socialLinks = [
  {
    name: "Twitter",
    href: (code: string, name: string) =>
      `https://twitter.com/share?url=https://farafina.tech/countries/${code}&text=Voir%20les%20informations%20%C3%A9lectorales%20de%20${name}`,
    title: "Partager sur Twitter",
    icon: FaTwitter,
  },
  {
    name: "LinkedIn",
    href: (code: string, name: string) =>
      `https://www.linkedin.com/sharing/share-offsite/?url=https://farafina.tech/countries/${code}`,
    title: "Partager sur LinkedIn",
    icon: FaLinkedin,
  },
  {
    href: (code: string, name: string) =>
      `https://www.facebook.com/sharer/sharer.php?u=https://farafina.tech/countries/${code}`,
    title: "Partager sur Facebook",
    icon: FaFacebookF,
  },
  {
    name: "Email",
    href: (code: string, name: string) =>
      `mailto:?subject=Voir%20les%20informations%20%C3%A9lectorales%20de%20${name}&body=https://farafina.tech/countries/${code}`,
    title: "Partager par Email",
    icon: FaEnvelope,
  },
];

// Simuler des articles r√©cents
const recentArticles = [
  {
    title: `Pr√©paration des √©lections de ${country.lastElection.nextElectionYear} au ${country.name}`,
    date: new Date().toLocaleDateString("fr-FR"),
    excerpt: `Les pr√©paratifs pour les prochaines √©lections ${country.lastElection.type.toLowerCase()} au ${country.name} ont commenc√©...`,
  },
  {
    title: `Analyse du syst√®me √©lectoral ${country.name.toLowerCase()}`,
    date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toLocaleDateString(
      "fr-FR",
    ),
    excerpt: `Une √©tude approfondie du syst√®me √©lectoral ${country.name.toLowerCase()} r√©v√®le des d√©fis et des opportunit√©s...`,
  },
];
---

<Layout title={`${country.name} - Informations √âlectorales`} pageType="detail">
  <PageHeader
    title={country.name}
    subtitle={`Syst√®me politique: ${country.politicalSystem}`}
    breadcrumbs={[
      { label: "Accueil", href: "/" },
      { label: "Pays", href: "/countries" },
      { label: country.name },
    ]}
    client:load
  >
    <FaGlobeAfrica className="text-farafina-primary text-3xl" slot="icon" />
  </PageHeader>

  <div data-pagefind-filter="section:Pays" class="container mx-auto px-4 py-8">
    <!-- Banni√®re du pays avec drapeau et statistiques cl√©s -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
      <!-- <div
        class="relative h-40 bg-gradient-to-r from-farafina-primary to-farafina-secondary"
      > -->
      <div class="relative h-40 bg-gradient-to-r from-[#00853F] to-[#E31B23]">
        <div
          class="absolute inset-0 opacity-20"
          style={`background-image: url(https://flagcdn.com/w1280/${country.code.toLowerCase()}.webp); background-size: cover; background-position: center;`}
        >
        </div>
        <div class="absolute inset-0 flex items-center px-8">
          <div class="flex items-center">
            <img
              src={`https://flagcdn.com/w160/${country.code.toLowerCase()}.webp`}
              alt={`Drapeau ${country.name}`}
              class="w-24 h-16 object-cover rounded shadow-md mr-6"
            />
            <div class="text-white">
              <h1 data-pagefind-index class="text-3xl font-bold">
                {country.name}
              </h1>
              <p class="text-white/80">Langues officielles: {country.langue}</p>
            </div>
          </div>
          <div class="flex items-center space-x-2 ml-auto">
            {
              socialLinks.map((link) => (
                <ToCountryLink
                  href={link.href(country.code.toLowerCase(), country.name)}
                  title={link.title}
                  iconLink={link.icon}
                />
              ))
            }
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-5 gap-6 p-6">
        {
          keyStats.map((stat) => (
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center mr-4">
                <stat.icon className={`text-xl ${stat.color}`} />
              </div>
              <div>
                <span class="block text-sm text-gray-500">{stat.label}</span>
                <span class="block text-xl font-bold text-farafina-dark">
                  {stat.value}
                </span>
              </div>
            </div>
          ))
        }
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
      <!-- Carte et informations g√©n√©rales -->
      <div class="lg:col-span-2 space-y-8">
        <!-- Carte interactive -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2
            class="text-xl font-bold text-farafina-primary mb-6 flex items-center"
          >
            <FaGlobeAfrica className="mr-2" /> Localisation
          </h2>
          <div class="h-[400px]">
            <AfricaMap client:load selectedCountry={country.code} />
          </div>
        </div>

        <!-- Donn√©es d√©mographiques -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2
            class="text-xl font-bold text-farafina-primary mb-6 flex items-center"
          >
            <FaUsers className="mr-2" /> Donn√©es D√©mographiques
          </h2>
          <DemographicChart
            client:visible
            demographics={country.demographics}
          />
        </div>
      </div>

      <!-- Sidebar avec informations et √©lections √† venir -->
      <div class="space-y-8">
        <!-- Informations du pays -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2
            class="text-xl font-bold text-farafina-primary mb-6 flex items-center"
          >
            <FaGlobeAfrica className="mr-2" /> Informations
          </h2>
          <CountryCard client:load country={CountryInterface} />
        </div>

        <!-- √âlections √† venir -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2
            class="text-xl font-bold text-farafina-secondary mb-6 flex items-center"
          >
            <FaCalendarAlt className="mr-2" /> Prochaine √âlection
          </h2>

          {
            upcomingElections.map((election) => (
              <div class="bg-farafina-secondary/5 rounded-lg p-4">
                <div class="flex justify-between items-center mb-3">
                  <span class="font-semibold text-farafina-dark">
                    {election.type}
                  </span>
                  <span class="text-sm text-gray-500">
                    {new Date(election.date).getFullYear()}
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <div class="text-sm text-gray-600">
                    <span class="font-medium">Jours restants:</span>
                  </div>
                  <div class="text-2xl font-bold text-farafina-secondary">
                    {election.daysRemaining}
                  </div>
                </div>
                <div class="mt-4">
                  <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div
                      class="bg-farafina-secondary h-2.5 rounded-full"
                      style={`width: ${100 - (election.daysRemaining / 365) * 100}%`}
                    />
                  </div>
                </div>
              </div>
            ))
          }

          <div class="mt-4">
            <a
              href="/elections/calendar"
              class="text-farafina-secondary hover:text-farafina-secondary/80 transition-colors text-sm"
            >
              Voir le calendrier √©lectoral complet ‚Üí
            </a>
          </div>
        </div>

        <!-- Articles r√©cents -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2
            class="text-xl font-bold text-farafina-accent mb-6 flex items-center"
          >
            <FaNewspaper className="mr-2" />  Articles r√©cents
          </h2>

           <input type="hidden" id="country" value={country.name} />
      <div id="newsList" class="space-y-4">
        <div class="flex items-center justify-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-farafina-accent"></div>
          <p class="ml-3 text-farafina-accent">Chargement des actualit√©s...</p>
        </div>
      </div>
      <button
        id="loadMoreNews"
        class="mt-4 px-4 py-2 bg-farafina-accent text-white rounded-lg hover:bg-transparent hover:border hover:border-farafina-accent hover:text-farafina-accent transition-colors w-full hidden"
        onclick="loadMoreNews()"
      >
        Voir plus
      </button>

          <script>
            // Configuration
            const CONFIG = {
              maxArticles: 2,
              loadMoreIncrement: 2,
              descriptionLength: 150,
              dateOptions: {
                weekday: "short",
                year: "numeric",
                month: "long",
              }
            };

            // Helper functions
            const helpers = {
              formatDate(pubDate) {
                return new Date(pubDate).toLocaleDateString("fr-FR", CONFIG.dateOptions);
              },

              cleanHtml(text) {
                return text.replace(/<[^>]*>?/gm, "");
              },

              createNewsElement(item) {
                const div = document.createElement("div");
                div.className = "border-b border-gray-100 pb-4 last:border-0 last:pb-0";

                const cleanDescription = this.cleanHtml(item.description);

                div.innerHTML = `
                  <h3 class="font-semibold text-farafina-dark hover:text-farafina-accent transition-colors">
                    <a href="${item.link}" target="_blank">${item.title}</a>
                  </h3>
                  <p class="text-sm text-gray-500 mb-2">üóìÔ∏è ${this.formatDate(item.pubDate)}</p>
                `;

                return div;
              },

              showError(newsList, message) {
                newsList.innerHTML = `<p class="text-sm text-gray-500">${message}</p>`;
              }
            };

            let allNewsItems = [];
            let currentDisplayCount = CONFIG.maxArticles;

            // Load more news function
            function loadMoreNews() {
              const nextItems = allNewsItems.slice(currentDisplayCount, currentDisplayCount + CONFIG.loadMoreIncrement);
              const newsList = document.getElementById("newsList");
              
              nextItems.forEach(item => newsList.appendChild(helpers.createNewsElement(item)));
              currentDisplayCount += CONFIG.loadMoreIncrement;

              // Hide button if no more items
              if (currentDisplayCount >= allNewsItems.length) {
                document.getElementById("loadMoreNews").classList.add("hidden");
              }
            }

            // Main news fetching function
            async function getNews() {
              const country = document.getElementById("country").value;
              const newsList = document.getElementById("newsList");
              const loadMoreButton = document.getElementById("loadMoreNews");

              if (!country) {
                helpers.showError(newsList, "");
                return;
              }

              try {
                const query = encodeURIComponent(`√©lections pr√©sidentielles OR l√©gislatives ${country}`);
                const rssUrl = `https://news.google.com/rss/search?q=${query}&hl=fr&gl=FR&ceid=FR:fr`;
                const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;

                const response = await fetch(apiUrl);
                const data = await response.json();

                if (!data.items?.length) {
                  helpers.showError(newsList, `Aucune actualit√© trouv√©e pour "${country}".`);
                  return;
                }

                allNewsItems = data.items;
                newsList.innerHTML = "";
                
                allNewsItems
                  .slice(0, CONFIG.maxArticles)
                  .forEach(item => newsList.appendChild(helpers.createNewsElement(item)));

                // Show load more button if there are more items
                if (allNewsItems.length > CONFIG.maxArticles) {
                  loadMoreButton.classList.remove("hidden");
                }

              } catch (error) {
                console.error(error);
                helpers.showError(newsList, "Erreur lors du chargement des actualit√©s.");
              }
            }

            // Initialize news loading
            getNews();
          </script>
        </div>
      </div>
    </div>

    <!-- Syst√®me √©lectoral et cadre juridique -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Syst√®me √©lectoral -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2
          class="text-xl font-bold text-farafina-primary mb-6 flex items-center"
        >
          <FaVoteYea className="mr-2" /> Syst√®me √âlectoral
        </h2>
        <div class="space-y-6">
          <div class="bg-farafina-primary/5 rounded-lg p-4">
            <h3 class="font-semibold text-farafina-primary mb-2">
              Syst√®me Politique
            </h3>
            <p class="text-gray-700">{country.politicalSystem}</p>
          </div>

          <div class="grid grid-cols-2 gap-6">
            <div class="bg-farafina-primary/5 rounded-lg p-4">
              <h3 class="font-semibold text-farafina-primary mb-2">
                Mod√®le de Gestion des √âlections
              </h3>
              <p class="text-gray-700">{electoralOrganism.electoralModel}</p>
            </div>
            <div class="bg-farafina-primary/5 rounded-lg p-4">
              <h3 class="font-semibold text-farafina-primary mb-2">
                Organismes √âlectoraux
              </h3>
              <ul class="list-disc pl-4">
                {
                  electoralOrganism.electoralOrganisms.map((eo) => (
                    <li>
                      <a
                        href={eo?.siteweb}
                        class="text-blue-600 underline hover:no-underline"
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        {eo.name}
                      </a>
                    </li>
                  ))
                }
              </ul>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-6">
            <div class="bg-farafina-primary/5 rounded-lg p-4">
              <h3 class="font-semibold text-farafina-primary mb-2">
                R√©gime de vote
              </h3>
              <ul class="list-disc pl-4">
                <li>
                  <span class="font-bold text-gray-700">Pr√©sidentiel</span>: {
                    electoralOrganism.vote.presidentialVote
                  }
                </li>
                <li>
                  <span class="font-bold text-gray-700">L√©gislatif</span>: {
                    electoralOrganism.vote.legislativeVote
                  }
                </li>
              </ul>
            </div>
            <div class="bg-farafina-primary/5 rounded-lg p-4">
              <h3 class="font-semibold text-farafina-primary mb-2">
                Mode de scrutin
              </h3>
              <ul class="list-disc pl-4">
                <li>
                  <span class="font-bold text-gray-700">Pr√©sidentiel</span>: {
                    electoralOrganism.vote.presidentialscrutinMode
                  }
                </li>
                <li>
                  <span class="font-bold text-gray-700">L√©gislatif</span>: {
                    electoralOrganism.vote.legislativeScrutinMode
                  }
                </li>
              </ul>
            </div>
          </div>

          <div class="bg-farafina-primary/5 rounded-lg p-4">
            <h3 class="font-semibold text-farafina-primary mb-2">
              Validation des candidatures
            </h3>
            <ul class="list-disc pl-4">
              <li>
                <span class="font-bold text-gray-700">Pr√©sidentiel</span>: {
                  electoralOrganism.vote.validationBody
                }
              </li>
              <li>
                <span class="font-bold text-gray-700">L√©gislatif</span>: {
                  electoralOrganism.vote.legislativeValidationBody
                }
              </li>
            </ul>
          </div>

          <div class="bg-farafina-primary/5 rounded-lg p-4">
            <h3 class="font-semibold text-farafina-primary mb-2">
              Organe de proclamation des r√©sultats provisoires
            </h3>
            <p class="text-gray-700">
              {electoralOrganism.vote.provisionalResultsBody}
            </p>
          </div>

          <div class="bg-farafina-primary/5 rounded-lg p-4">
            <h3 class="font-semibold text-farafina-primary mb-2">
              Organe de proclamation des r√©sultats d√©finitifs
            </h3>
            <ul class="list-disc pl-4">
              <li>
                <span class="font-bold text-gray-700">Pr√©sidentiel</span>: {
                  electoralOrganism.vote.presidentialResults
                }
              </li>
              <li>
                <span class="font-bold text-gray-700">L√©gislatif</span>: {
                  electoralOrganism.vote.legislativeResults
                }
              </li>
            </ul>
          </div>

          <div class="bg-farafina-primary/5 rounded-lg p-4">
            <h3 class="font-semibold text-farafina-primary mb-2">
              Gestion du contentieux √©lectoral
            </h3>
            <p class="text-gray-700">
              {electoralOrganism.vote.disputesManagementBody}
            </p>
          </div>
        </div>
      </div>

      <!-- Ressources suppl√©mentaires -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-xl font-bold text-farafina-blue mb-6 flex items-center">
          <FaBalanceScale className="mr-2" /> Ressources suppl√©mentaires
        </h2>
        <LegalFramework
          client:visible
          documents={legalFramework?.documents || legalFramework.documents}
          timeline={electoralOrganism?.vote || electoralOrganism.vote}
          organisations={organisation}
          electoralOrganism={electoralOrganism?.vote || electoralOrganism.vote}
        />
      </div>
    </div>

    <!-- Chronologie √©lectorale -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
      <h2 class="text-xl font-bold text-farafina-accent mb-6 flex items-center">
        <FaCalendarAlt className="mr-2" /> Chronologie √âlectorale
      </h2>
      <ElectionTimeline
        client:visible
        events={electionEvents}
        countryName={country.name}
      />
    </div>

    <!-- Liste des d√©fis √©lectoraux -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-farafina-accent flex items-center">
          <FaExclamationTriangle className="mr-2" /> Les d√©fis √©lectoraux
        </h2>
        <a
          href="/elections/challenges"
          class="text-farafina-accent hover:text-farafina-accent/80 transition-colors text-sm font-medium"
        >
          Voir tous les d√©fis ‚Üí
        </a>
      </div>

      <div class="space-y-6">
        <div class="grid grid-cols-3 gap-6">
          <div class="text-sm p-5 text-gray-500">
            <h4>Type de d√©fi</h4>
          </div>
          <div class="text-sm p-2 text-gray-500">
            <h4>Description</h4>
          </div>
          <div class="text-sm text-gray-500"></div>
        </div>
        {(() => {
          // R√©cup√©rer tous les d√©fis et les trier par date
          const allDefis = electionEvents
            .flatMap(event => event.defis.map(defi => ({...defi, dateElection: event.date})))
            .sort((a, b) => new Date(b.dateElection).getTime() - new Date(a.dateElection).getTime());

          const initialCount = 2;
          const visibleDefis = allDefis.slice(0, initialCount);
          const remainingDefis = allDefis.slice(initialCount);

          return (
            <>
              {visibleDefis.map((challenge) => (
                <div
                  key={challenge.libelle}
                  class="border border-red-100 rounded-lg p-5 hover:shadow-md transition-shadow"
                >
                  <div class="grid grid-cols-3 gap-6">
                    <p class="font-medium text-farafina-accent">
                      {challenge.type} - {new Date(challenge.dateElection).toLocaleDateString('fr-FR')}
                    </p>
                    <p class="text-gray-700">{challenge.libelle}</p>
                    <div class="flex justify-end">
                      <a
                        href={challenge.url}
                        target="_blank"
                        class="text-farafina-accent hover:text-farafina-accent/80 transition-colors"
                      >
                        Voir l'analyse compl√®te ‚Üí
                      </a>
                    </div>
                  </div>
                </div>
              ))}

              {remainingDefis.length > 0 && (
                <div class="hidden" id="defis-more">
                  {remainingDefis.map((challenge) => (
                    <div
                      key={challenge.libelle}
                      class="border border-red-100 rounded-lg p-5 hover:shadow-md transition-shadow"
                    >
                      <div class="grid grid-cols-3 gap-6">
                        <p class="font-medium text-farafina-accent">
                          {challenge.type} - {new Date(challenge.dateElection).toLocaleDateString('fr-FR')}
                        </p>
                        <p class="text-gray-700">{challenge.libelle}</p>
                        <div class="flex justify-end">
                          <a
                            href={challenge.url}
                            target="_blank"
                            class="text-farafina-accent hover:text-farafina-accent/80 transition-colors"
                          >
                            Voir l'analyse compl√®te ‚Üí
                          </a>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {remainingDefis.length > 0 && (
                <button
                  class="mt-4 px-4 py-2 bg-farafina-accent text-white rounded-lg hover:bg-transparent hover:border hover:border-farafina-accent hover:text-farafina-accent transition-colors w-full"
                  onclick={`
                    const moreContent = document.getElementById('defis-more');
                    const isHidden = moreContent.classList.contains('hidden');
                    moreContent.classList.toggle('hidden');
                    this.textContent = isHidden ? 'Voir moins' : 'Voir plus';
                  `}
                >
                  Voir plus
                </button>
              )}
            </>
          );
        })()}
      </div>
    </div>

    
  </div>

  <!-- Ressources et liens utiles -->
  <div
    class="bg-gradient-to-r from-farafina-primary to-farafina-secondary rounded-xl shadow-md overflow-hidden"
  >
    <div class="grid grid-cols-1 md:grid-cols-2">
      <div class="p-8 text-white">
        <h2 class="text-2xl font-bold mb-4">Ressources suppl√©mentaires</h2>
        <p class="mb-6 text-white/90">
          Acc√©dez √† notre base de donn√©es compl√®te sur les √©lections, les
          r√©sultats et les analyses concernant {country.name}.
        </p>
        <div class="space-y-3">
          <a
            href={`/elections?country=${country.code.toLowerCase()}`}
            class="block px-6 py-3 bg-white text-farafina-primary font-medium rounded-lg hover:bg-white/90 transition-colors"
          >
            Voir les √©lections de {country.name}
          </a>
          <a
            href="/resources"
            class="block px-6 py-3 bg-white/20 text-white font-medium rounded-lg hover:bg-white/30 transition-colors"
          >
            Consulter les rapports d'analyse
          </a>
        </div>
      </div>
      <div class="hidden md:block relative">
        <Image
          src="/images/mapping.webp"
          alt={`Ressources sur ${country.name}`}
          class="w-full h-full object-cover"
          width={400}
          height={300}
          inferSize
        />
        <div class="absolute inset-0 bg-black/20"></div>
      </div>
    </div>
  </div>
</div>
</Layout>